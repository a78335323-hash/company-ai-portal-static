<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Portal AI</title>

<style>
body { margin:0; font-family:Arial; display:flex; height:100vh; }

/* SIDEBAR */
.sidebar { width:270px; padding:14px; color:white; display:flex; flex-direction:column; justify-content:space-between; background:#2ecc71; }

/* PULSANTI UNIFICATI */
.sidebar-btn { width:100%; padding:12px; margin-bottom:10px; border-radius:10px; font-size:14px; cursor:pointer; text-align:center; background:rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.45); box-sizing:border-box; }
.sidebar-btn:hover { background: rgba(255,255,255,0.28); }

/* CERCA CHAT */
.search-wrapper { position:relative; width:100%; display:flex; align-items:center; justify-content:center; }
.search-wrapper input { width:100%; background:transparent; border:none; outline:none; color:white; padding:12px; text-align:center; font-size:14px; }

/* CHAT LIST */
.chat-title { font-size:13px; opacity:0.85; margin:14px 0 6px; }
.chat-item { padding:8px; border-radius:8px; cursor:pointer; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
.chat-item:hover { background: rgba(255,255,255,0.18); }
.chat-item.active { background: rgba(255,255,255,0.35); }
.chat-item .delete-btn { color:red; cursor:pointer; font-weight:bold; margin-left:8px; }

/* PROFILO */
.profile-box { padding:10px; border-radius:10px; background:rgba(255,255,255,0.18); display:flex; align-items:center; }
.avatar { width:34px; height:34px; border-radius:50%; background:white; color:#333; font-weight:bold; display:flex; align-items:center; justify-content:center; margin-right:8px; }
.profile-name { flex:1; font-size:13px; }
.change { background:white; color:#333; border:none; font-size:11px; padding:4px 8px; border-radius:6px; cursor:pointer; }

/* MAIN */
.main { flex:1; padding:30px; position:relative; display:flex; justify-content:center; background:#f7f7f7; }
.container { width:88%; display:flex; flex-direction:column; }

/* LOGO */
#logoLink { position:absolute; top:5px; right:10px; }
#logo { width:90px; cursor:pointer; }

/* CHAT */
.chat { flex:1; background:white; border-radius:16px; padding:22px; overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
.msg-user, .msg-ai { margin:12px 0; display:flex; }
.msg-user { justify-content:flex-end; }
.msg-ai { justify-content:flex-start; }
.msg-user span, .msg-ai span { padding:12px 16px; border-radius:16px; max-width:75%; white-space:pre-wrap; word-wrap:break-word; font-size:15px; }
.msg-user span { background:#dcf8c6; }
.msg-ai span { background:#f1f1f1; }

/* INPUT */
.input { margin-top:12px; display:flex; align-items:center; }
textarea { flex:1; resize:none; padding:14px; border-radius:12px; border:1px solid #ccc; min-height:48px; max-height:160px; font-size:15px; }
.send { margin-left:10px; padding:0 22px; border-radius:12px; border:none; color:white; cursor:pointer; font-size:15px; background:#2ecc71; }

/* MICROFONO */
.mic-btn { margin-right:10px; padding:0; width:44px; height:44px; border-radius:50%; border:none; background:#4285f4; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; }

/* PULSANTI SALVA / DOWNLOAD FUORI SIDEBAR */
.top-buttons { position:absolute; top:10px; left:10px; z-index:999; display:flex; flex-direction:column; gap:6px; }
.top-buttons button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fff; color:#333; cursor:pointer; }
.top-buttons button:hover { background:#eee; }
</style>
</head>

<body>

<div class="top-buttons">
  <button id="saveBtn">Salva chat</button>
  <button id="downloadBtn">Scarica .txt</button>
</div>

<div class="sidebar" id="sidebar">
  <div>
    <div class="sidebar-btn" id="newChatBtn">Nuova chat</div>
    <div class="sidebar-btn search-wrapper">
      <input id="search" placeholder="Cerca chat">
    </div>
    <div class="sidebar-btn" id="promemoriaBtn">Promemoria</div>
    <div class="sidebar-btn" id="telefonateBtn">Telefonate</div>
    <div class="chat-title">Le tue chat</div>
    <div id="chatList"></div>
  </div>
  <div class="profile-box">
    <div class="avatar" id="avatar"></div>
    <div class="profile-name" id="profileName"></div>
    <button class="change" id="changeUserBtn">cambia</button>
  </div>
</div>

<div class="main">
  <a id="logoLink" target="_blank"><img id="logo"></a>
  <div class="container">
    <div class="chat" id="chat"></div>
    <div class="input" id="inputBox">
      <button class="mic-btn" id="mic">üé§</button>
      <textarea id="msg" placeholder="Scrivi un messaggio..."></textarea>
      <button class="send" id="send">Invia</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   BLOCCO ACCESSO SENZA LOGIN
=================================*/
const token = localStorage.getItem("token");
const storedUser = localStorage.getItem("user");

if (!token || !storedUser) {
  window.location.replace("index.html");
}

const user = storedUser || "Utente";
const company = localStorage.getItem("company") || "Lucagri";
/* ===============================
   PROMEMORIA: STORAGE PER UTENTE+AZIENDA
=================================*/
function remindersKey() {
  return `reminders:${company}:${user}`;
}

function loadReminders() {
  try {
    return JSON.parse(localStorage.getItem(remindersKey()) || "[]");
  } catch {
    return [];
  }
}

function saveReminders(list) {
  localStorage.setItem(remindersKey(), JSON.stringify(list));
}

function addReminder(item) {
  const list = loadReminders();
  list.unshift(item);
  saveReminders(list);
}

function updateReminder(id, patch) {
  const list = loadReminders().map(r => (r.id === id ? { ...r, ...patch } : r));
  saveReminders(list);
}

function deleteReminder(id) {
  const list = loadReminders().filter(r => r.id !== id);
  saveReminders(list);
}


/* ===============================
   INIZIALIZZAZIONE
=================================*/
const avatar = document.getElementById("avatar");
const profileName = document.getElementById("profileName");
const sidebar = document.getElementById("sidebar");
const sendBtn = document.getElementById("send");
const logo = document.getElementById("logo");
const logoLink = document.getElementById("logoLink");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const inputBox = document.getElementById("inputBox");
const micBtn = document.getElementById("mic");
const saveBtn = document.getElementById("saveBtn");
const downloadBtn = document.getElementById("downloadBtn");
const chatList = document.getElementById("chatList");

let chatHistory = [];
let chatModified = false;

avatar.textContent = user.slice(0,2).toUpperCase();
profileName.textContent = user;

const companyData = {
 Lucagri:{sidebar:"linear-gradient(180deg,#7de3a2,#2ecc71)",send:"#2ecc71",logo:"logo.png",link:"https://www.lucagri.it/"},
 Agrichampion:{sidebar:"linear-gradient(180deg,#ffdba8,#f39c12)",send:"#f39c12",logo:"logo2.png",link:"https://agrichampion.com/"},
 Cabreganze:{sidebar:"linear-gradient(180deg,#f6e6a8,#d4af37)",send:"#d4af37",logo:"logo3.jpg",link:"https://www.cabreganze.com/"}
};

const theme = companyData[company] || companyData.Lucagri;
sidebar.style.background = theme.sidebar;
sendBtn.style.background = theme.send;
logo.src = theme.logo;
logoLink.href = theme.link;

ai("Come posso aiutarti?");
showPromemoria();

/* ===============================
   PROMEMORIA: STORAGE PER UTENTE+AZIENDA
=================================*/
function remindersKey() {
  return `reminders:${company}:${user}`;
}

function loadReminders() {
  try {
    return JSON.parse(localStorage.getItem(remindersKey()) || "[]");
  } catch {
    return [];
  }
}

function saveReminders(list) {
  localStorage.setItem(remindersKey(), JSON.stringify(list));
}

function addReminder(item) {
  const list = loadReminders();
  list.unshift(item);
  saveReminders(list);
}

function updateReminder(id, patch) {
  const list = loadReminders().map(r => (r.id === id ? { ...r, ...patch } : r));
  saveReminders(list);
}

function deleteReminder(id) {
  const list = loadReminders().filter(r => r.id !== id);
  saveReminders(list);
}

/* ===============================
   FUNZIONI CHAT
=================================*/
function ai(text){ chat.innerHTML += `<div class="msg-ai"><span>${text}</span></div>`; chat.scrollTop=chat.scrollHeight; chatModified=true; }
function userMsg(text){ chat.innerHTML += `<div class="msg-user"><span>${text}</span></div>`; chat.scrollTop=chat.scrollHeight; chatModified=true; }

/* ===============================
   HELPERS PROMEMORIA (escape + parsing "ricordami")
=================================*/
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatShort(ts){
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function tryCreateReminderFromChat(textRaw){
  const text = (textRaw || "").trim();
  const low = text.toLowerCase();

  if (!low.startsWith("ricordami")) return null;

  let rest = text.slice("ricordami".length).trim();

  let dueAt = null;
  const now = new Date();
  const baseToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0, 0);

  if (rest.toLowerCase().startsWith("oggi")) {
    dueAt = baseToday.getTime();
    rest = rest.slice(4).trim();
  } else if (rest.toLowerCase().startsWith("domani")) {
    const d = new Date(baseToday);
    d.setDate(d.getDate()+1);
    dueAt = d.getTime();
    rest = rest.slice(6).trim();
  } else {
    const m = rest.match(/^(il\s+)?(\d{1,2})\/(\d{1,2})(\/(\d{4}))?/i);
    if (m) {
      const dd = parseInt(m[2],10);
      const mm = parseInt(m[3],10) - 1;
      const yyyy = m[5] ? parseInt(m[5],10) : now.getFullYear();
      const d = new Date(yyyy, mm, dd, 9, 0, 0, 0);
      dueAt = d.getTime();
      rest = rest.slice(m[0].length).trim();
    }
  }

  const t = rest.match(/^(alle\s+)?(\d{1,2}):(\d{2})/i);
  if (t) {
    const hh = Math.min(23, Math.max(0, parseInt(t[2],10)));
    const mi = Math.min(59, Math.max(0, parseInt(t[3],10)));
    const d = dueAt ? new Date(dueAt) : new Date(baseToday);
    d.setHours(hh, mi, 0, 0);
    dueAt = d.getTime();
    rest = rest.slice(t[0].length).trim();
  }

  rest = rest.replace(/^di\s+/i, "").trim();
  if (!rest) return null;

  if (!dueAt) dueAt = baseToday.getTime();

  const item = {
    id: `r_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    text: rest,
    dueAt,
    createdAt: Date.now(),
    done: false,
    doneAt: null,
    source: "chat"
  };

  addReminder(item);
  return item;
}

/* ===============================
   SALVATAGGIO / DOWNLOAD
=================================*/
function saveChat(){
  if(chatHistory.length===0){ alert("Niente da salvare"); return; }
  let name = prompt("Nome della chat","");
  if(!name) return;
  let savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
  savedChats.push({name:name,history:chatHistory});
  localStorage.setItem("savedChats",JSON.stringify(savedChats));
  addChatToList(name);
  chatHistory=[]; chat.innerHTML=""; ai("Come posso aiutarti?");
  chatModified=false;
  alert("Chat salvata come '"+name+"'");
}

function addChatToList(name){
  const div = document.createElement("div");
  div.className="chat-item";
  div.innerHTML = `<span>${name}</span><span class="delete-btn">√ó</span>`;
  const deleteBtn = div.querySelector(".delete-btn");
  deleteBtn.onclick = (e)=>{
    e.stopPropagation();
    if(confirm("Sei sicuro di voler eliminare questa chat?")){
      let savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
      savedChats = savedChats.filter(c=>c.name!==name);
      localStorage.setItem("savedChats",JSON.stringify(savedChats));
      div.remove();
    }
  };
  div.onclick = ()=>{
    if(chatModified && chatHistory.length>0 && !confirm("Ci sono modifiche non salvate, procedere?")) return;
    const savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
    const c = savedChats.find(c=>c.name===name);
    if(c){ chat.innerHTML=""; chatHistory=c.history; chatHistory.forEach(m=>{ if(m.role==='user') userMsg(m.content); else ai(m.content); }); chatModified=false; inputBox.style.display="flex"; }
  };
  chatList.appendChild(div);
}

function downloadChat(){
  if(chatHistory.length===0){ alert("Niente da scaricare"); return; }
  let fileName = prompt("Nome file","");
  if(!fileName) return;
  let text = chatHistory.map(m=>(m.role==='user'?'Utente':'AI')+": "+m.content).join("\n");
  let a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text],{type:"text/plain"}));
  a.download = fileName+".txt";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===============================
   INVIO MESSAGGI
=================================*/
sendBtn.onclick = async ()=>{
  if(!msg.value.trim()) return;
  const text = msg.value; msg.value="";

    const created = tryCreateReminderFromChat(text);
  if (created) {
    userMsg(text); chatHistory.push({ role:"user", content:text });

    ai(`‚úÖ Promemoria creato: "${escapeHtml(created.text)}" (${formatShort(created.dueAt)})`);
    chatHistory.push({ role:"assistant", content:`Promemoria creato: ${created.text}` });

    if (chat.innerHTML.includes("<h3>Promemoria</h3>")) showPromemoria();
    return;
  }


  userMsg(text); chatHistory.push({role:"user",content:text});
  const loadId = Date.now();
  chat.innerHTML += `<div class="msg-ai" id="ai_${loadId}"><span>Sto elaborando la risposta...</span></div>`;
  try{
    const res = await fetch("https://company-ai-portal-static.onrender.com/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:chatHistory})});
    const data = await res.json();
    const box = document.getElementById(`ai_${loadId}`);
    if(data.success){ box.innerHTML=`<span>${data.reply}</span>`; chatHistory.push({role:"assistant",content:data.reply}); chatModified=true; }
    else box.innerHTML=`<span>Errore AI: ${data.error}</span>`;
  }catch(err){ document.getElementById(`ai_${loadId}`).innerHTML=`<span>Errore connessione server</span>`; }
};

msg.addEventListener("keydown",e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

/* ===============================
   MICROFONO ATTIVO
=================================*/
if('webkitSpeechRecognition' in window){
  const recognition = new webkitSpeechRecognition();
  recognition.lang="it-IT";
  recognition.continuous=false;
  recognition.interimResults=false;
  micBtn.onclick=()=> recognition.start();
  recognition.onresult = function(event){
    const spoken = event.results[0][0].transcript;
    msg.value=spoken;
    sendBtn.click();
  };
}

/* ===============================
   NAVIGAZIONE
=================================*/
function askSave(callback){ if(chatModified && chatHistory.length>0){ if(confirm("La chat ha modifiche non salvate, vuoi salvare?")) saveChat(); } callback(); }

document.getElementById("newChatBtn").onclick = ()=>askSave(()=>{ chatHistory=[]; chat.innerHTML=""; ai("Come posso aiutarti?"); inputBox.style.display="flex"; });
document.getElementById("promemoriaBtn").onclick = ()=>askSave(showPromemoria);
document.getElementById("telefonateBtn").onclick = ()=>askSave(showTelefonate);

document.getElementById("changeUserBtn").onclick = ()=>askSave(()=>{
  localStorage.removeItem("token");
  localStorage.removeItem("user");
  window.location.href = "index.html";
});

window.addEventListener("beforeunload",(e)=>{ if(chatModified && chatHistory.length>0){ e.preventDefault(); e.returnValue="La chat ha modifiche non salvate, vuoi salvare?"; } });

/* ===============================
   CERCA CHAT
=================================*/
document.getElementById("search").addEventListener("input",e=>{
  let f=e.target.value.toLowerCase();
  document.querySelectorAll("#chatList .chat-item").forEach(item=>{ item.style.display=item.textContent.toLowerCase().includes(f)?"flex":"none"; });
});

/* ===============================
   PULSANTI SALVA / DOWNLOAD
=================================*/
saveBtn.onclick = saveChat;
downloadBtn.onclick = downloadChat;

/* ===============================
   SEZIONI
=================================*/
function showPromemoria(){
  const list = loadReminders();

  const now = new Date();
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const endOfToday = startOfToday + 24*60*60*1000;

  const dueToday = [];
  const dueFuture = [];
  const done = [];

  for (const r of list) {
    if (r.done) { done.push(r); continue; }
    if (typeof r.dueAt === "number" && r.dueAt >= startOfToday && r.dueAt < endOfToday) dueToday.push(r);
    else dueFuture.push(r);
  }

  chat.innerHTML = `
    <div style="font-size:16px;line-height:1.6">
      <h3>Promemoria</h3>

      <button id="genCallsBtn"
        style="margin-bottom:12px;padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer">
        Genera chiamate di oggi (demo)
      </button>

      <h4>üìÖ Oggi</h4>
      ${dueToday.length ? dueToday.map(r => reminderRow(r)).join("") : "<p>Nessun promemoria oggi</p>"}

      <h4>‚è≥ Prossimi</h4>
      ${dueFuture.length ? dueFuture.map(r => reminderRow(r)).join("") : "<p>Nessun promemoria futuro</p>"}

      <h4>‚úÖ Completati</h4>
      ${done.length ? done.map(r => reminderRow(r, true)).join("") : "<p>Nessun promemoria completato</p>"}
    </div>
  `;

  inputBox.style.display = "none";

  // collega il bottone "Genera chiamate"
const btn = document.getElementById("genCallsBtn");
if (btn) {
  btn.onclick = () => {
    generateTodayCallRemindersDemo();
    showPromemoria(); // ricarica la lista
  };
}
  // üëâ COLLEGAMENTO BOTTONE
  const btn = document.getElementById("genCallsBtn");
  if (btn) {
    btn.onclick = () => {
      generateTodayCallRemindersDemo();
      showPromemoria(); // refresh vista
    };
  }
}


  function row(r){
    const when = r.dueAt ? ` <span style="opacity:.75;font-size:12px">(${formatShort(r.dueAt)})</span>` : "";
    return `
      <div style="display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid #eee;border-radius:10px;margin:8px 0">
        <input type="checkbox" ${r.done ? "checked" : ""} data-act="toggle" data-id="${r.id}" style="margin-top:3px">
        <div style="flex:1">
          <div style="font-size:15px">${escapeHtml(r.text)}${when}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <button data-act="tomorrow" data-id="${r.id}" style="padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">Domani</button>
            <button data-act="delete" data-id="${r.id}" style="padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">Elimina</button>
          </div>
        </div>
      </div>
    `;
  }

  chat.innerHTML = `
    <div style="font-size:17px;line-height:1.7">
      <h3>Promemoria</h3>
      <button id="genCallsBtn" style="margin-bottom:12px;padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer">
  Genera chiamate di oggi (demo)
</button>

      <p style="margin-top:-8px;opacity:.8">
        Scrivi in chat: <b>‚Äúricordami ...‚Äù</b> per crearne uno.<br>
        Esempi: <i>‚Äúricordami domani di chiamare Mario‚Äù</i> ‚Äì <i>‚Äúricordami il 25/01/2026 alle 16:30 di mandare deplan a Marco‚Äù</i>
      </p>

      <h4>üìÖ Oggi</h4>
      ${dueToday.length ? dueToday.map(row).join("") : `<p style="opacity:.7">Nessun promemoria per oggi.</p>`}

      <h4>‚è≥ Prossimi</h4>
      ${dueFuture.length ? dueFuture.map(row).join("") : `<p style="opacity:.7">Nessun promemoria futuro.</p>`}

      <h4>‚úÖ Completati</h4>
      ${done.length ? done.slice(0,30).map(row).join("") : `<p style="opacity:.7">Nessun completato.</p>`}
    </div>
  `;

  inputBox.style.display="flex";

  chat.querySelectorAll("[data-act]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const act = el.getAttribute("data-act");
      const id = el.getAttribute("data-id");

      if (act === "delete") {
        deleteReminder(id);
        showPromemoria();
      }

      if (act === "tomorrow") {
        const d = new Date();
        d.setDate(d.getDate()+1);
        d.setHours(9,0,0,0);
        updateReminder(id, { dueAt: d.getTime() });
        showPromemoria();
      }
    });
  });

  chat.querySelectorAll('input[type="checkbox"][data-act="toggle"]').forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const id = cb.getAttribute("data-id");
      updateReminder(id, { done: cb.checked, doneAt: cb.checked ? Date.now() : null });
      showPromemoria();
    });
  });
}

function showTelefonate(){ chat.innerHTML=`<div style="font-size:17px;line-height:1.7"><h3>Telefonate</h3><h4>‚úîÔ∏è Interessati</h4><table border="1" cellpadding="6" style="border-collapse:collapse;width:100%"><tr><th>Nome</th><th>Numero</th><th>Data chiamata</th></tr><tr><td>Mario Rossi</td><td>3331234567</td><td>05/01/2026</td></tr><tr><td>Lucia Bianchi</td><td>3499876543</td><td>07/01/2026</td></tr></table><br><h4>üìß Da reinviare email</h4><table border="1" cellpadding="6" style="border-collapse:collapse;width:100%"><tr><th>Nome</th><th>Email</th><th>Data chiamata</th></tr><tr><td>Paolo Verdi</td><td>paolo@example.com</td><td>06/01/2026</td></tr><tr><td>Anna Blu</td><td>anna@example.com</td><td>08/01/2026</td></tr></table></div>`; inputBox.style.display="none"; }
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatShort(ts){
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function tryCreateReminderFromChat(textRaw){
  const text = (textRaw || "").trim();
  const low = text.toLowerCase();

  if (!low.startsWith("ricordami")) return null;

  let rest = text.slice("ricordami".length).trim();

  let dueAt = null;
  const now = new Date();
  const baseToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0, 0);

  if (rest.toLowerCase().startsWith("oggi")) {
    dueAt = baseToday.getTime();
    rest = rest.slice(4).trim();
  } else if (rest.toLowerCase().startsWith("domani")) {
    const d = new Date(baseToday);
    d.setDate(d.getDate()+1);
    dueAt = d.getTime();
    rest = rest.slice(6).trim();
  } else {
    const m = rest.match(/^(il\s+)?(\d{1,2})\/(\d{1,2})(\/(\d{4}))?/i);
    if (m) {
      const dd = parseInt(m[2],10);
      const mm = parseInt(m[3],10) - 1;
      const yyyy = m[5] ? parseInt(m[5],10) : now.getFullYear();
      const d = new Date(yyyy, mm, dd, 9, 0, 0, 0);
      dueAt = d.getTime();
      rest = rest.slice(m[0].length).trim();
    }
  }

  const t = rest.match(/^(alle\s+)?(\d{1,2}):(\d{2})/i);
  if (t) {
    const hh = Math.min(23, Math.max(0, parseInt(t[2],10)));
    const mi = Math.min(59, Math.max(0, parseInt(t[3],10)));
    const d = dueAt ? new Date(dueAt) : new Date(baseToday);
    d.setHours(hh, mi, 0, 0);
    dueAt = d.getTime();
    rest = rest.slice(t[0].length).trim();
  }

  rest = rest.replace(/^di\s+/i, "").trim();
  if (!rest) return null;

  if (!dueAt) dueAt = baseToday.getTime();

  const item = {
    id: `r_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    text: rest,
    dueAt,
    createdAt: Date.now(),
    done: false,
    doneAt: null,
    source: "chat"
  };

  addReminder(item);
  return item;
}

</script>

</body>
</html>
