<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Portal AI</title>

<style>
body { margin:0; font-family:Arial; display:flex; height:100vh; }

/* SIDEBAR */
.sidebar { width:270px; padding:14px; color:white; display:flex; flex-direction:column; justify-content:space-between; background:#2ecc71; }

/* PULSANTI UNIFICATI */
.sidebar-btn { width:100%; padding:12px; margin-bottom:10px; border-radius:10px; font-size:14px; cursor:pointer; text-align:center; background:rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.45); box-sizing:border-box; }
.sidebar-btn:hover { background: rgba(255,255,255,0.28); }

/* CERCA CHAT */
.search-wrapper { position:relative; width:100%; display:flex; align-items:center; justify-content:center; }
.search-wrapper input { width:100%; background:transparent; border:none; outline:none; color:white; padding:12px; text-align:center; font-size:14px; }

/* CHAT LIST */
.chat-title { font-size:13px; opacity:0.85; margin:14px 0 6px; }
.chat-item { padding:8px; border-radius:8px; cursor:pointer; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
.chat-item:hover { background: rgba(255,255,255,0.18); }
.chat-item.active { background: rgba(255,255,255,0.35); }
.chat-item .delete-btn { color:red; cursor:pointer; font-weight:bold; margin-left:8px; }

/* PROFILO */
.profile-box { padding:10px; border-radius:10px; background:rgba(255,255,255,0.18); display:flex; align-items:center; }
.avatar { width:34px; height:34px; border-radius:50%; background:white; color:#333; font-weight:bold; display:flex; align-items:center; justify-content:center; margin-right:8px; }
.profile-name { flex:1; font-size:13px; }
.change { background:white; color:#333; border:none; font-size:11px; padding:4px 8px; border-radius:6px; cursor:pointer; }

/* MAIN */
.main { flex:1; padding:30px; position:relative; display:flex; justify-content:center; background:#f7f7f7; }
.container { width:88%; display:flex; flex-direction:column; }

/* LOGO */
#logoLink { position:absolute; top:5px; right:10px; }
#logo { width:90px; cursor:pointer; }

/* CHAT */
.chat { flex:1; background:white; border-radius:16px; padding:22px; overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
.msg-user, .msg-ai { margin:12px 0; display:flex; }
.msg-user { justify-content:flex-end; }
.msg-ai { justify-content:flex-start; }
.msg-user span, .msg-ai span { padding:12px 16px; border-radius:16px; max-width:75%; white-space:pre-wrap; word-wrap:break-word; font-size:15px; }
.msg-user span { background:#dcf8c6; }
.msg-ai span { background:#f1f1f1; }

/* INPUT */
.input { margin-top:12px; display:flex; align-items:center; }
textarea { flex:1; resize:none; padding:14px; border-radius:12px; border:1px solid #ccc; min-height:48px; max-height:160px; font-size:15px; }
.send { margin-left:10px; padding:0 22px; border-radius:12px; border:none; color:white; cursor:pointer; font-size:15px; background:#2ecc71; }

/* MICROFONO */
.mic-btn { margin-right:10px; padding:0; width:44px; height:44px; border-radius:50%; border:none; background:#4285f4; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; }

/* PULSANTI SALVA / DOWNLOAD FUORI SIDEBAR */
.top-buttons { position:absolute; top:10px; left:10px; z-index:999; display:flex; flex-direction:column; gap:6px; }
.top-buttons button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fff; color:#333; cursor:pointer; }
.top-buttons button:hover { background:#eee; }

.side-actions{
  display:flex;
  gap:8px;
  margin:10px 0;
}
.side-actions button{
  flex:1;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.45);
  background:rgba(255,255,255,0.18);
  color:white;
  cursor:pointer;
}
.side-actions button:hover{
  background: rgba(255,255,255,0.28);
}

</style>
</head>

<body>


<div class="sidebar" id="sidebar">
  <div>
    <div class="sidebar-btn" id="newChatBtn">Nuova chat</div>
    
    <div class="side-actions">
    <button id="saveBtn">Salva chat</button>
    <button id="downloadBtn">Scarica .txt</button>
    </div>
    
    <div class="sidebar-btn search-wrapper">
      <input id="search" placeholder="Cerca chat">
    </div>
    <div class="sidebar-btn" id="promemoriaBtn">Promemoria</div>
    <div class="sidebar-btn" id="telefonateBtn">Telefonate</div>
    <div class="chat-title">Le tue chat</div>
    <div id="chatList"></div>
  </div>
  <div class="profile-box">
    <div class="avatar" id="avatar"></div>
    <div class="profile-name" id="profileName"></div>
    <button class="change" id="changeUserBtn">cambia</button>
  </div>
</div>

<div class="main">
  <a id="logoLink" target="_blank"><img id="logo"></a>
  <div class="container">
    <div class="chat" id="chat"></div>
    <div class="input" id="inputBox">
      <button class="mic-btn" id="mic">üé§</button>
      <textarea id="msg" placeholder="Scrivi un messaggio..."></textarea>
      <button class="send" id="send">Invia</button>
    </div>
  </div>
</div>
<script>
/* ===============================
   BLOCCO LOGIN
================================= */
const token = localStorage.getItem("token");
const user = localStorage.getItem("user");
const company = localStorage.getItem("company") || "Lucagri";

if (!token || !user) location.href = "index.html";

/* ===============================
   DOM
================================= */
const avatar = document.getElementById("avatar");
const profileName = document.getElementById("profileName");
const sidebar = document.getElementById("sidebar");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const inputBox = document.getElementById("inputBox");
const saveBtn = document.getElementById("saveBtn");
const downloadBtn = document.getElementById("downloadBtn");
const chatList = document.getElementById("chatList");

avatar.textContent = user.slice(0,2).toUpperCase();
profileName.textContent = user;

/* ===============================
   THEME
================================= */
const logo = document.getElementById("logo");
const logoLink = document.getElementById("logoLink");

const companyDataFull = {
  Lucagri: {
    sidebar: "#2ecc71",
    logo: "logo.png",
    link: "https://www.lucagri.it/"
  },
  Agrichampion: {
    sidebar: "#f39c12",
    logo: "logo2.png",
    link: "https://agrichampion.com/"
  }
};

const theme = companyDataFull[company] || companyDataFull.Lucagri;

sidebar.style.background = theme.sidebar;
logo.src = theme.logo;
logoLink.href = theme.link;


/* ===============================
   CHAT CORE
================================= */
let chatHistory = [];

function ai(t){
  chat.innerHTML += `<div class="msg-ai"><span>${escapeHtml(t)}</span></div>`;
  chat.scrollTop = chat.scrollHeight;
}
function userMsg(t){
  chat.innerHTML += `<div class="msg-user"><span>${escapeHtml(t)}</span></div>`;
  chat.scrollTop = chat.scrollHeight;
}

/* ===============================
   PROMEMORIA STORAGE
================================= */
const REM_KEY = `reminders:${company}:${user}`;
const loadReminders = ()=>JSON.parse(localStorage.getItem(REM_KEY)||"[]");
const saveReminders = l=>localStorage.setItem(REM_KEY,JSON.stringify(l));

/* ===============================
   VISTA "OGGI" AUTOMATICA (NUOVO)
================================= */
function hasRemindersToday(){
  const list = loadReminders();
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const end = start + 24*60*60*1000;

  return list.some(r => !r.done && typeof r.dueAt === "number" && r.dueAt >= start && r.dueAt < end);
}

/* ===============================
   PROMEMORIA PARSER
================================= */
function tryCreateReminderFromChat(text){
  const low = text.toLowerCase();
  if(!low.startsWith("ricordami")) return null;

  const item = {
    id:"r_"+Date.now(),
    text:text.replace(/ricordami\s*/i,""),
    dueAt:Date.now(),
    done:false
  };
  const list = loadReminders();
  list.unshift(item);
  saveReminders(list);
  return item;
}

/* ===============================
   AVVIO (NUOVO): OGGI AUTOMATICO
================================= */
if (hasRemindersToday()) {
  showPromemoria();
} else {
  ai("Come posso aiutarti?");
  inputBox.style.display = "flex";
}

/* ===============================
   INVIO MESSAGGI (CHAT + PROMEMORIA)
================================= */
sendBtn.onclick = async ()=>{
  if(!msg.value.trim()) return;
  const text = msg.value.trim();
  msg.value = "";

  const reminder = tryCreateReminderFromChat(text);
  if(reminder){
    userMsg(text);
    ai("‚úÖ Promemoria creato");
    showPromemoria();
    return;
  }

  userMsg(text);
  chatHistory.push({role:"user",content:text});

  const id = Date.now();
  chat.innerHTML += `<div class="msg-ai" id="ai_${id}"><span>Sto pensando...</span></div>`;

  try{
    const r = await fetch("https://company-ai-portal-static.onrender.com/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({history:chatHistory})
    });
    const d = await r.json();
    document.getElementById(`ai_${id}`).innerHTML =
      `<span>${escapeHtml(d.reply||"Errore")}</span>`;
    chatHistory.push({role:"assistant",content:d.reply});
  }catch{
    document.getElementById(`ai_${id}`).innerHTML =
      `<span>Errore connessione</span>`;
  }
};

/* ===============================
   PROMEMORIA VIEW
================================= */
function showPromemoria(){
  const list = loadReminders();
  chat.innerHTML = `
    <h3>Promemoria</h3>
    ${list.map(r=>`
      <div style="padding:10px;border:1px solid #ddd;border-radius:10px;margin:8px 0">
        <b>${escapeHtml(r.text)}</b><br>
        <button data-id="${r.id}" data-act="done">‚úîÔ∏è Fatto</button>
        <button data-id="${r.id}" data-act="delete">üóë</button>
      </div>
    `).join("") || "<p>Nessun promemoria</p>"}
  `;
  inputBox.style.display="none";
}

/* ===============================
   PROMEMORIA ACTIONS
================================= */
chat.addEventListener("click",e=>{
  const id = e.target.dataset.id;
  const act = e.target.dataset.act;
  if(!id||!act) return;

  let list = loadReminders();
  if(act==="done") list = list.filter(r=>r.id!==id);
  if(act==="delete") list = list.filter(r=>r.id!==id);
  saveReminders(list);
  showPromemoria();
});

/* ===============================
   HELPERS
================================= */
function escapeHtml(s){
  return s.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

/* ===============================
   BUTTONS
================================= */
document.getElementById("promemoriaBtn").onclick = showPromemoria;
document.getElementById("newChatBtn").onclick = ()=>{
  chat.innerHTML=""; chatHistory=[]; ai("Come posso aiutarti?");
  inputBox.style.display="flex";
};
document.getElementById("changeUserBtn").onclick = ()=>{
  localStorage.clear(); location.href="index.html";
};
</script>

</body>
</html>
