<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Portal AI</title>

<style>
body { margin:0; font-family:Arial; display:flex; height:100vh; }

/* SIDEBAR */
.sidebar { width:270px; padding:14px; color:white; display:flex; flex-direction:column; justify-content:space-between; }

/* PULSANTI UNIFICATI */
.sidebar-btn { width:100%; padding:12px; margin-bottom:10px; border-radius:10px; font-size:14px; cursor:pointer; text-align:center; background:rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.45); box-sizing:border-box; }
.sidebar-btn:hover { background: rgba(255,255,255,0.28); }

/* CERCA CHAT */
.search-wrapper { position:relative; width:100%; display:flex; align-items:center; justify-content:center; }
.search-wrapper input { width:100%; background:transparent; border:none; outline:none; color:white; padding:12px; text-align:center; font-size:14px; }

/* CHAT LIST */
.chat-title { font-size:13px; opacity:0.85; margin:14px 0 6px; }
.chat-item { padding:8px; border-radius:8px; cursor:pointer; font-size:14px; }
.chat-item:hover { background: rgba(255,255,255,0.18); }
.chat-item.active { background: rgba(255,255,255,0.35); }

/* PROFILO */
.profile-box { padding:10px; border-radius:10px; background:rgba(255,255,255,0.18); display:flex; align-items:center; }
.avatar { width:34px; height:34px; border-radius:50%; background:white; color:#333; font-weight:bold; display:flex; align-items:center; justify-content:center; margin-right:8px; }
.profile-name { flex:1; font-size:13px; }
.change { background:white; color:#333; border:none; font-size:11px; padding:4px 8px; border-radius:6px; cursor:pointer; }

/* MAIN */
.main { flex:1; padding:30px; position:relative; display:flex; justify-content:center; }
.container { width:88%; display:flex; flex-direction:column; }

/* LOGO */
#logoLink { position:absolute; top:5px; right:10px; }
#logo { width:90px; cursor:pointer; }

/* CHAT */
.chat { flex:1; background:white; border-radius:16px; padding:22px; overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
.msg-user, .msg-ai { margin:12px 0; display:flex; }
.msg-user { justify-content:flex-end; }
.msg-ai { justify-content:flex-start; }
.msg-user span, .msg-ai span { padding:12px 16px; border-radius:16px; max-width:75%; white-space:pre-wrap; word-wrap:break-word; font-size:15px; }
.msg-user span { background:#dcf8c6; }
.msg-ai span { background:#f1f1f1; }

/* INPUT */
.input { margin-top:12px; display:flex; align-items:center; }
textarea { flex:1; resize:none; padding:14px; border-radius:12px; border:1px solid #ccc; min-height:48px; max-height:160px; font-size:15px; }
.send { margin-left:10px; padding:0 22px; border-radius:12px; border:none; color:white; cursor:pointer; font-size:15px; }

/* MICROFONO */
.mic-btn { margin-right:10px; padding:0; width:44px; height:44px; border-radius:50%; border:none; background:#4285f4; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
</style>
</head>

<body>

<div class="sidebar" id="sidebar">

<div>
<div class="sidebar-btn" onclick="newChat()">Nuova chat</div>

<div class="sidebar-btn search-wrapper">
<input id="search" placeholder="Cerca chat">
</div>

<div class="sidebar-btn" onclick="showPromemoria()">Promemoria</div>
<div class="sidebar-btn" onclick="showTelefonate()">Telefonate</div>

<div class="chat-title">Le tue chat</div>

<div id="chatList">
<div class="chat-item">Preventivo Bobman</div>
<div class="chat-item">Fattura Rossi</div>
<div class="chat-item">Listino 2025</div>
</div>
</div>

<div class="profile-box">
<div class="avatar" id="avatar"></div>
<div class="profile-name" id="profileName"></div>
<button class="change" onclick="location.href='index.html'">cambia</button>
</div>

</div>

<div class="main">

<a id="logoLink" target="_blank"><img id="logo"></a>

<div class="container">
<div class="chat" id="chat"></div>

<div class="input" id="inputBox">
<button class="mic-btn" id="mic">üé§</button>
<textarea id="msg" placeholder="Scrivi un messaggio..."></textarea>
<button class="send" id="send">Invia</button>
</div>

</div>
</div>

<script>
/* ===============================
   INIZIALIZZAZIONE
=================================*/

const user = localStorage.getItem("user") || "Utente";
const company = localStorage.getItem("company") || "Lucagri";

const avatar = document.getElementById("avatar");
const profileName = document.getElementById("profileName");
const sidebar = document.getElementById("sidebar");
const sendBtn = document.getElementById("send");
const logo = document.getElementById("logo");
const logoLink = document.getElementById("logoLink");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const search = document.getElementById("search");
const inputBox = document.getElementById("inputBox");
const micBtn = document.getElementById("mic");

/* üî• MEMORIA CHAT IN PAGINA */
let chatHistory = [];

/* AVATAR */
avatar.textContent = user.slice(0,2).toUpperCase();
profileName.textContent = user;

/* TEMI AZIENDA */
const companyData = {
  Lucagri:{sidebar:"linear-gradient(180deg,#7de3a2,#2ecc71)",send:"#2ecc71",logo:"logo.png",link:"https://www.lucagri.it/"},
  Agrichampion:{sidebar:"linear-gradient(180deg,#ffdba8,#f39c12)",send:"#f39c12",logo:"logo2.png",link:"https://agrichampion.com/"},
  Cabreganze:{sidebar:"linear-gradient(180deg,#f6e6a8,#d4af37)",send:"#d4af37",logo:"logo3.jpg",link:"https://www.cabreganze.com/"}
};

const theme = companyData[company] || companyData.Lucagri;
sidebar.style.background = theme.sidebar;
sendBtn.style.background = theme.send;
logo.src = theme.logo;
logoLink.href = theme.link;

/* ===============================
   CHAT UI
=================================*/

function ai(text){
  chat.innerHTML += `<div class="msg-ai"><span>${text}</span></div>`;
  chat.scrollTop = chat.scrollHeight;
}

function userMsg(text){
  chat.innerHTML += `<div class="msg-user"><span>${text}</span></div>`;
  chat.scrollTop = chat.scrollHeight;
}

/* primo messaggio */
ai("Come posso aiutarti?");

/* nuova chat */
function newChat(){
  chat.innerHTML = "";
  chatHistory = [];
  ai("Come posso aiutarti?");
}

/* ===============================
   SEZIONI STATICHE
=================================*/

function showPromemoria(){
  chat.innerHTML = `
  <div style="font-size:17px; line-height:1.7">
    <h3>Promemoria</h3>
    <p>Chiamare cliente</p>
    <p>Inviare fattura</p>
    <p>Controllare ordini</p>
    <p>üìû Richiamare interessati</p>
    <p>üìß Reinviare email</p>
  </div>`;
  inputBox.style.display="none";
}

function showTelefonate(){
  chat.innerHTML = `
  <div style="font-size:17px; line-height:1.7">
    <h3>Telefonate</h3>
    <h4>‚úîÔ∏è Interessati</h4>
    <table border="1" cellpadding="6" style="border-collapse:collapse; width:100%;">
      <tr><th>Nome</th><th>Numero</th><th>Data chiamata</th></tr>
      <tr><td>Mario Rossi</td><td>3331234567</td><td>05/01/2026</td></tr>
      <tr><td>Lucia Bianchi</td><td>3499876543</td><td>07/01/2026</td></tr>
    </table>
    <br>
    <h4>üìß Da reinviare email</h4>
    <table border="1" cellpadding="6" style="border-collapse:collapse; width:100%;">
      <tr><th>Nome</th><th>Email</th><th>Data chiamata</th></tr>
      <tr><td>Paolo Verdi</td><td>paolo@example.com</td><td>06/01/2026</td></tr>
      <tr><td>Anna Blu</td><td>anna@example.com</td><td>08/01/2026</td></tr>
    </table>
  </div>`;
  inputBox.style.display="none";
}

/* ===============================
   INVIO MESSAGGIO + MEMORIA + RATE LIMIT
=================================*/

sendBtn.onclick = async () => {
  if(!msg.value.trim()) return;

  const text = msg.value;
  msg.value = "";
  userMsg(text);

  const loadId = Date.now();
  chat.innerHTML += `<div class="msg-ai" id="ai_${loadId}"><span>Sto elaborando la risposta...</span></div>`;

  chatHistory.push({role:"user", content:text});

  const maxRetries = 5;
  let attempt = 0;

  async function trySend() {
    attempt++;
    try {
      const res = await fetch("https://company-ai-portal-static.onrender.com/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({history: chatHistory})
      });

      const data = await res.json();
      const box = document.getElementById(`ai_${loadId}`);

      if(data.success){
        box.innerHTML = `<span>${data.reply}</span>`;
        chatHistory.push({role:"assistant", content:data.reply});
      } else if(data.error && data.error.includes("Rate limit")){
        if(attempt <= maxRetries){
          box.innerHTML = `<span>Attendere qualche secondo, sto ritentando... (tentativo ${attempt})</span>`;
          setTimeout(trySend, 5000); // ritenta dopo 5 secondi
        } else {
          box.innerHTML = `<span>Errore AI: limite di richieste superato. Riprova pi√π tardi.</span>`;
        }
      } else {
        box.innerHTML = `<span>Errore AI: ${data.error}</span>`;
      }

    } catch(err){
      const box = document.getElementById(`ai_${loadId}`);
      if(attempt <= maxRetries){
        box.innerHTML = `<span>Connessione persa, ritento (tentativo ${attempt})...</span>`;
        setTimeout(trySend, 5000);
      } else {
        box.innerHTML = `<span>Errore connessione server</span>`;
      }
    }

    chat.scrollTop = chat.scrollHeight;
  }

  trySend();
};

/* ENTER */
msg.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});
</script>


</body>
</html>
