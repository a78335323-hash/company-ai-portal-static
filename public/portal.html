<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Portal AI</title>

<style>
body { margin:0; font-family:Arial; display:flex; height:100vh; }

/* SIDEBAR */
.sidebar { width:270px; padding:14px; color:white; display:flex; flex-direction:column; justify-content:space-between; background:#2ecc71; }

/* PULSANTI UNIFICATI */
.sidebar-btn { width:100%; padding:12px; margin-bottom:10px; border-radius:10px; font-size:14px; cursor:pointer; text-align:center; background:rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.45); box-sizing:border-box; }
.sidebar-btn:hover { background: rgba(255,255,255,0.28); }

/* CERCA CHAT */
.search-wrapper { position:relative; width:100%; display:flex; align-items:center; justify-content:center; }
.search-wrapper input { width:100%; background:transparent; border:none; outline:none; color:white; padding:12px; text-align:center; font-size:14px; }

/* CHAT LIST */
.chat-title { font-size:13px; opacity:0.85; margin:14px 0 6px; }
.chat-item { padding:8px; border-radius:8px; cursor:pointer; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
.chat-item:hover { background: rgba(255,255,255,0.18); }
.chat-item.active { background: rgba(255,255,255,0.35); }
.chat-item .delete-btn { color:red; cursor:pointer; font-weight:bold; margin-left:8px; }

/* PROFILO */
.profile-box { padding:10px; border-radius:10px; background:rgba(255,255,255,0.18); display:flex; align-items:center; }
.avatar { width:34px; height:34px; border-radius:50%; background:white; color:#333; font-weight:bold; display:flex; align-items:center; justify-content:center; margin-right:8px; }
.profile-name { flex:1; font-size:13px; }
.change { background:white; color:#333; border:none; font-size:11px; padding:4px 8px; border-radius:6px; cursor:pointer; }

/* MAIN */
.main { flex:1; padding:30px; position:relative; display:flex; justify-content:center; background:#f7f7f7; }
.container { width:88%; display:flex; flex-direction:column; }

/* LOGO */
#logoLink { position:absolute; top:5px; right:10px; }
#logo { width:90px; cursor:pointer; }

/* CHAT */
.chat { flex:1; background:white; border-radius:16px; padding:22px; overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
.msg-user, .msg-ai { margin:12px 0; display:flex; }
.msg-user { justify-content:flex-end; }
.msg-ai { justify-content:flex-start; }
.msg-user span, .msg-ai span { padding:12px 16px; border-radius:16px; max-width:75%; white-space:pre-wrap; word-wrap:break-word; font-size:15px; }
.msg-user span { background:#dcf8c6; }
.msg-ai span { background:#f1f1f1; }

/* INPUT */
.input { margin-top:12px; display:flex; align-items:center; }
textarea { flex:1; resize:none; padding:14px; border-radius:12px; border:1px solid #ccc; min-height:48px; max-height:160px; font-size:15px; }
.send { margin-left:10px; padding:0 22px; border-radius:12px; border:none; color:white; cursor:pointer; font-size:15px; background:#2ecc71; }

/* MICROFONO */
.mic-btn { margin-right:10px; padding:0; width:44px; height:44px; border-radius:50%; border:none; background:#4285f4; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; }

/* PULSANTI SALVA / DOWNLOAD FUORI SIDEBAR */
.top-buttons { position:absolute; top:10px; left:10px; z-index:999; display:flex; flex-direction:column; gap:6px; }
.top-buttons button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fff; color:#333; cursor:pointer; }
.top-buttons button:hover { background:#eee; }

.side-actions{
  display:flex;
  gap:8px;
  margin:10px 0;
}
.side-actions button{
  flex:1;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.45);
  background:rgba(255,255,255,0.18);
  color:white;
  cursor:pointer;
}
.side-actions button:hover{
  background: rgba(255,255,255,0.28);
}
</style>
</head>

<body>

<div class="sidebar" id="sidebar">
  <div>
    <div class="sidebar-btn" id="newChatBtn">Nuova chat</div>

    <div class="side-actions">
      <button id="saveBtn">Salva chat</button>
      <button id="downloadBtn">Scarica .txt</button>
    </div>

    <div class="sidebar-btn search-wrapper">
      <input id="search" placeholder="Cerca chat">
    </div>
    <div class="sidebar-btn" id="promemoriaBtn">Promemoria</div>
    <div class="sidebar-btn" id="telefonateBtn">Telefonate</div>
    <div class="chat-title">Le tue chat</div>
    <div id="chatList"></div>
  </div>
  <div class="profile-box">
    <div class="avatar" id="avatar"></div>
    <div class="profile-name" id="profileName"></div>
    <button class="change" id="changeUserBtn">cambia</button>
  </div>
</div>

<div class="main">
  <a id="logoLink" target="_blank"><img id="logo"></a>
  <div class="container">
    <div class="chat" id="chat"></div>
    <div class="input" id="inputBox">
      <button class="mic-btn" id="mic">üé§</button>
      <textarea id="msg" placeholder="Scrivi un messaggio..."></textarea>
      <button class="send" id="send">Invia</button>
    </div>
  </div>
</div>

<!-- Supabase (UNA SOLA VOLTA, fuori dallo script principale) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===============================
   SUPABASE CONFIG
================================= */
const SUPABASE_URL = "https://yjpqmevwzoqdtkahxdej.supabase.co";
const SUPABASE_KEY = "sb_publishable_08Xb3z6ASnEn9dl84UG4_Q_L_4gHqfw";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===============================
   BLOCCO LOGIN
================================= */
const token = localStorage.getItem("token");
const user = localStorage.getItem("user");
const company = localStorage.getItem("company") || "Lucagri";
if (!token || !user) location.href = "index.html";

/* ===============================
   DOM
================================= */
const avatar = document.getElementById("avatar");
const profileName = document.getElementById("profileName");
const sidebar = document.getElementById("sidebar");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const inputBox = document.getElementById("inputBox");
const saveBtn = document.getElementById("saveBtn");
const downloadBtn = document.getElementById("downloadBtn");
const chatList = document.getElementById("chatList");
const micBtn = document.getElementById("mic");

avatar.textContent = user.slice(0,2).toUpperCase();
profileName.textContent = user;

/* ===============================
   THEME + LOGO
================================= */
const logo = document.getElementById("logo");
const logoLink = document.getElementById("logoLink");

const companyDataFull = {
  Lucagri: {
    sidebar: "linear-gradient(180deg,#7de3a2,#2ecc71)",
    send: "#2ecc71",
    logo: "logo.png",
    link: "https://www.lucagri.it/"
  },
  Agrichampion: {
    sidebar: "linear-gradient(180deg,#ffdba8,#f39c12)",
    send: "#f39c12",
    logo: "logo2.png",
    link: "https://agrichampion.com/"
  }
};

const theme = companyDataFull[company] || companyDataFull.Lucagri;
sidebar.style.background = theme.sidebar;
sendBtn.style.background = theme.send;
logo.src = theme.logo;
logoLink.href = theme.link;

/* ===============================
   CHAT CORE
================================= */
let chatHistory = [];
let chatModified = false;

function ai(t){
  chat.innerHTML += `<div class="msg-ai"><span>${escapeHtml(t)}</span></div>`;
  chat.scrollTop = chat.scrollHeight;
  chatModified = true;
}
function userMsg(t){
  chat.innerHTML += `<div class="msg-user"><span>${escapeHtml(t)}</span></div>`;
  chat.scrollTop = chat.scrollHeight;
  chatModified = true;
}

/* ===============================
   HELPERS
================================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function formatShort(ts){
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function parseReminder(textRaw){
  const text = (textRaw || "").trim();
  const low = text.toLowerCase();
  if (!low.startsWith("ricordami")) return null;

  let rest = text.slice("ricordami".length).trim();

  let dueAt = null;
  const now = new Date();
  const baseToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0, 0);

  if (rest.toLowerCase().startsWith("oggi")) {
    dueAt = baseToday.getTime();
    rest = rest.slice(4).trim();
  } else if (rest.toLowerCase().startsWith("domani")) {
    const d = new Date(baseToday);
    d.setDate(d.getDate()+1);
    dueAt = d.getTime();
    rest = rest.slice(6).trim();
  } else {
    const m = rest.match(/^(il\s+)?(\d{1,2})\/(\d{1,2})(\/(\d{4}))?/i);
    if (m) {
      const dd = parseInt(m[2],10);
      const mm = parseInt(m[3],10) - 1;
      const yyyy = m[5] ? parseInt(m[5],10) : now.getFullYear();
      const d = new Date(yyyy, mm, dd, 9, 0, 0, 0);
      dueAt = d.getTime();
      rest = rest.slice(m[0].length).trim();
    }
  }

  const t = rest.match(/^(alle\s+)?(\d{1,2}):(\d{2})/i);
  if (t) {
    const hh = Math.min(23, Math.max(0, parseInt(t[2],10)));
    const mi = Math.min(59, Math.max(0, parseInt(t[3],10)));
    const d = dueAt ? new Date(dueAt) : new Date(baseToday);
    d.setHours(hh, mi, 0, 0);
    dueAt = d.getTime();
    rest = rest.slice(t[0].length).trim();
  }

  rest = rest.replace(/^di\s+/i, "").trim();
  if (!rest) return null;
  if (!dueAt) dueAt = baseToday.getTime();

  return { text: rest, dueAt };
}

/* ===============================
   PROMEMORIA (SUPABASE)
================================= */
async function hasRemindersToday(){
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
  const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1).toISOString();

  const { data, error } = await supabaseClient
    .from("reminders")
    .select("id")
    .eq("user_email", user)
    .eq("company", company)
    .gte("due_at", start)
    .lt("due_at", end)
    .limit(1);

  if (error) return false;
  return (data && data.length > 0);
}

async function createReminderInDb(text, dueAtMs){
  const dueIso = new Date(dueAtMs).toISOString();
  const { error } = await supabaseClient
    .from("reminders")
    .insert([{ user_email: user, company: company, text: text, due_at: dueIso }]);
  return !error;
}

async function deleteReminderInDb(id){
  await supabaseClient.from("reminders").delete().eq("id", id);
}

async function showPromemoria(){
  inputBox.style.display = "none";
  chat.innerHTML = "<div style='font-size:17px;line-height:1.7'><h3>Promemoria</h3><p>Caricamento...</p></div>";

  const { data, error } = await supabaseClient
    .from("reminders")
    .select("*")
    .eq("user_email", user)
    .eq("company", company)
    .order("due_at", { ascending: true });

  if (error) {
    chat.innerHTML = "<div style='font-size:17px;line-height:1.7'><h3>Promemoria</h3><p style='color:red'>Errore caricamento promemoria</p></div>";
    return;
  }

  if (!data || data.length === 0) {
    chat.innerHTML = "<div style='font-size:17px;line-height:1.7'><h3>Promemoria</h3><p>Nessun promemoria</p></div>";
    return;
  }

  chat.innerHTML = `
    <div style="font-size:17px;line-height:1.7">
      <h3>Promemoria</h3>
      ${data.map(r => `
        <div style="padding:10px;border:1px solid #ddd;border-radius:10px;margin:8px 0">
          <b>${escapeHtml(r.text)}</b>
          <span style="opacity:.75;font-size:12px">(${formatShort(r.due_at)})</span><br>
          <button data-id="${r.id}" data-act="done" style="margin-top:8px;padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">‚úîÔ∏è Fatto</button>
          <button data-id="${r.id}" data-act="delete" style="margin-top:8px;margin-left:6px;padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">üóë</button>
        </div>
      `).join("")}
    </div>
  `;
}

/* ===============================
   TELEFONATE (placeholder)
================================= */
function showTelefonate(){
  chat.innerHTML = `<div style="font-size:17px;line-height:1.7">
    <h3>Telefonate</h3>
    <p style="opacity:.8">Sezione in preparazione (la colleghiamo alla tabella <b>calls</b> dopo i promemoria).</p>
  </div>`;
  inputBox.style.display = "none";
}

/* ===============================
   INVIO MESSAGGI (CHAT + PROMEMORIA)
================================= */
async function handleSend(){
  if(!msg.value.trim()) return;
  const text = msg.value.trim();
  msg.value = "";

  // 1) Se √® un "ricordami ..." crea promemoria su Supabase
  const parsed = parseReminder(text);
  if (parsed) {
    userMsg(text);
    const ok = await createReminderInDb(parsed.text, parsed.dueAt);
    if (ok) {
      ai(`‚úÖ Promemoria creato: "${parsed.text}" (${formatShort(parsed.dueAt)})`);
      await showPromemoria();
    } else {
      ai("‚ùå Errore: non sono riuscito a salvare il promemoria su Supabase");
      inputBox.style.display = "flex";
    }
    return;
  }

  // 2) Chat normale con AI
  userMsg(text);
  chatHistory.push({role:"user",content:text});

  const id = Date.now();
  chat.innerHTML += `<div class="msg-ai" id="ai_${id}"><span>Sto pensando...</span></div>`;
  chat.scrollTop = chat.scrollHeight;

  try{
    const r = await fetch("https://company-ai-portal-static.onrender.com/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({history:chatHistory})
    });
    const d = await r.json();
    document.getElementById(`ai_${id}`).innerHTML =
      `<span>${escapeHtml(d.reply||"Errore")}</span>`;
    chatHistory.push({role:"assistant",content:d.reply || "Errore"});
    chatModified = true;
  }catch{
    document.getElementById(`ai_${id}`).innerHTML = `<span>Errore connessione</span>`;
  }
}

sendBtn.onclick = handleSend;

// INVIO da tastiera (Enter = invia, Shift+Enter = a capo)
msg.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    handleSend();
  }
});

/* ===============================
   CLICK ACTIONS PROMEMORIA
================================= */
chat.addEventListener("click", async (e) => {
  const id = e.target?.dataset?.id;
  const act = e.target?.dataset?.act;
  if (!id || !act) return;

  if (act === "done" || act === "delete") {
    await deleteReminderInDb(id);
    await showPromemoria();
  }
});

/* ===============================
   SALVA / DOWNLOAD CHAT
================================= */
function saveChat(){
  if(chatHistory.length===0){ alert("Niente da salvare"); return; }
  let name = prompt("Nome della chat","");
  if(!name) return;

  let savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
  savedChats.push({name:name,history:chatHistory});
  localStorage.setItem("savedChats",JSON.stringify(savedChats));
  addChatToList(name);

  chatHistory=[]; chat.innerHTML=""; ai("Come posso aiutarti?");
  chatModified=false;
  alert("Chat salvata come '"+name+"'");
}

function addChatToList(name){
  const div = document.createElement("div");
  div.className="chat-item";
  div.innerHTML = `<span>${escapeHtml(name)}</span><span class="delete-btn">√ó</span>`;

  const deleteBtn = div.querySelector(".delete-btn");
  deleteBtn.onclick = (ev)=>{
    ev.stopPropagation();
    if(confirm("Sei sicuro di voler eliminare questa chat?")){
      let savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
      savedChats = savedChats.filter(c=>c.name!==name);
      localStorage.setItem("savedChats",JSON.stringify(savedChats));
      div.remove();
    }
  };

  div.onclick = ()=>{
    if(chatModified && chatHistory.length>0 && !confirm("Ci sono modifiche non salvate, procedere?")) return;
    const savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
    const c = savedChats.find(c=>c.name===name);
    if(c){
      chat.innerHTML=""; chatHistory=c.history;
      chatHistory.forEach(m=>{ if(m.role==='user') userMsg(m.content); else ai(m.content); });
      chatModified=false;
      inputBox.style.display="flex";
    }
  };

  chatList.appendChild(div);
}

function loadSavedChatsList(){
  const savedChats = JSON.parse(localStorage.getItem("savedChats")||"[]");
  chatList.innerHTML = "";
  savedChats.forEach(c=>addChatToList(c.name));
}

function downloadChat(){
  if(chatHistory.length===0){ alert("Niente da scaricare"); return; }
  let fileName = prompt("Nome file","");
  if(!fileName) return;
  let text = chatHistory.map(m=>(m.role==='user'?'Utente':'AI')+": "+m.content).join("\n");
  let a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text],{type:"text/plain"}));
  a.download = fileName+".txt";
  a.click();
  URL.revokeObjectURL(a.href);
}

saveBtn.onclick = saveChat;
downloadBtn.onclick = downloadChat;

/* ===============================
   NAV / BUTTONS
================================= */
function askSave(callback){
  if(chatModified && chatHistory.length>0){
    if(confirm("La chat ha modifiche non salvate, vuoi salvare?")) saveChat();
  }
  callback();
}

document.getElementById("newChatBtn").onclick = ()=>askSave(()=>{
  chatHistory=[]; chat.innerHTML=""; ai("Come posso aiutarti?");
  inputBox.style.display="flex";
});

document.getElementById("promemoriaBtn").onclick = ()=>askSave(showPromemoria);
document.getElementById("telefonateBtn").onclick = ()=>askSave(showTelefonate);

document.getElementById("changeUserBtn").onclick = ()=>askSave(()=>{
  localStorage.removeItem("token");
  localStorage.removeItem("user");
  // NON faccio clear() cos√¨ non butti via savedChats
  location.href="index.html";
});

window.addEventListener("beforeunload",(e)=>{
  if(chatModified && chatHistory.length>0){
    e.preventDefault();
    e.returnValue="La chat ha modifiche non salvate, vuoi salvare?";
  }
});

/* ===============================
   CERCA CHAT
================================= */
document.getElementById("search").addEventListener("input",e=>{
  let f=e.target.value.toLowerCase();
  document.querySelectorAll("#chatList .chat-item").forEach(item=>{
    item.style.display=item.textContent.toLowerCase().includes(f)?"flex":"none";
  });
});

/* ===============================
   MICROFONO
================================= */
if('webkitSpeechRecognition' in window){
  const recognition = new webkitSpeechRecognition();
  recognition.lang="it-IT";
  recognition.continuous=false;
  recognition.interimResults=false;
  micBtn.onclick=()=> recognition.start();
  recognition.onresult = function(event){
    const spoken = event.results[0][0].transcript;
    msg.value=spoken;
    handleSend();
  };
}

/* ===============================
   AVVIO
================================= */
(async function init(){
  loadSavedChatsList();

  // Vista automatica: se hai promemoria per oggi => apri Promemoria, altrimenti chat normale
  const today = await hasRemindersToday();
  if (today) {
    await showPromemoria();
  } else {
    ai("Come posso aiutarti?");
    inputBox.style.display = "flex";
  }
})();
</script>

</body>
</html>
