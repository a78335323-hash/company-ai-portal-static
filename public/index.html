<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Gestione personale AI</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: white;
}

.login {
    background: white;
    width: 420px;
    padding: 30px 45px;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    text-align: center;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#logo {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 90px;
}

select, input {
    width: 100%;
    padding: 14px;
    margin-bottom: 18px;
    border-radius: 8px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 14px;
    box-sizing: border-box;
}

#remember {
    margin-right: -5px;
    width: auto;
}

button {
    width: 55%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
}

button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.forgot {
    font-size: 12px;
    color: #2980b9;
    cursor: pointer;
    margin-bottom: 20px;
    text-align: center;
}

.rememberBox {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-bottom: 18px;
    font-size: 13px;
    white-space: nowrap;
}

.password-wrapper {
    position: relative;
    width: 100%;
}

.togglePassword {
    position: absolute;
    right: 10px;
    top: 35%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 18px;
    color: #555;
    user-select: none;
    width: 32px;
    height: 32px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: white;
}

.error {
    color: #e74c3c;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 15px;
    display: none;
}
</style>
</head>

<body>

<div class="login">
    <img id="logo" src="logo.png">

    <h2>Gestione personale AI</h2>

    <select id="company">
        <option value="Lucagri">Lucagri</option>
        <option value="Agrichampion">Agrichampion</option>
    </select>

    <input type="email" id="email" placeholder="Il tuo indirizzo email">

    <div class="password-wrapper">
        <input type="password" id="password" placeholder="La tua password">
        <span class="togglePassword" id="togglePassword">üëÅÔ∏è</span>
    </div>

    <div class="error" id="errorMsg"></div>

    <div class="rememberBox">
        <input type="checkbox" id="remember">
        <label for="remember">memorizza dati di accesso</label>
    </div>

    <div class="forgot" onclick="location.href='forgot.html'">
        Hai dimenticato la password?
    </div>

    <button id="login">Accedi</button>
</div>

<script>
function applyTheme(company) {
    const body = document.body;
    const logo = document.getElementById("logo");
    const btn = document.getElementById("login");

    if (company === "Lucagri") {
        body.style.background = "#e0f2e9";
        btn.style.background = "#2ecc71";
        logo.src = "logo.png";
    } else {
        body.style.background = "#fff3e0";
        btn.style.background = "#f39c12";
        logo.src = "logo2.png";
    }
}

window.addEventListener("DOMContentLoaded", () => {
    const companySelect = document.getElementById("company");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const remember = document.getElementById("remember");
    const loginBtn = document.getElementById("login");
    const togglePassword = document.getElementById("togglePassword");
    const errorMsg = document.getElementById("errorMsg");

    const savedCompany = localStorage.getItem("company") || "Lucagri";
    companySelect.value = savedCompany;
    applyTheme(savedCompany);

    if (localStorage.getItem("remember") === "true") {
        remember.checked = true;
        emailInput.value = localStorage.getItem("savedEmail") || "";
        passwordInput.value = localStorage.getItem("savedPassword") || "";
    }

    companySelect.addEventListener("change", () => {
        localStorage.setItem("company", companySelect.value);
        applyTheme(companySelect.value);
    });

    togglePassword.addEventListener("click", () => {
        passwordInput.type = passwordInput.type === "password" ? "text" : "password";
        togglePassword.textContent = passwordInput.type === "password" ? "üëÅÔ∏è" : "üôà";
    });

    loginBtn.addEventListener("click", async () => {
        errorMsg.style.display = "none";

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            errorMsg.textContent = "Inserisci un'email valida";
            errorMsg.style.display = "block";
            return;
        }

        if (password.length < 6) {
            errorMsg.textContent = "La password deve avere almeno 6 caratteri";
            errorMsg.style.display = "block";
            return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Accesso in corso...";

        try {
            const res = await fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                     email: emailInput.value,
                     password: passwordInput.value
                    company: companySelect.value
                })
            });

            if (!res.ok) throw new Error("Credenziali errate");

            const data = await res.json();

            if (remember.checked) {
                localStorage.setItem("remember", "true");
                localStorage.setItem("savedEmail", email);
                localStorage.setItem("savedPassword", password);
            } else {
                localStorage.clear();
            }

            localStorage.setItem("user", email);
            localStorage.setItem("token", data.token);

            location.href = "portal.html";

        } catch (err) {
            errorMsg.textContent = "Email o password non corretti";
            errorMsg.style.display = "block";
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = "Accedi";
        }
    });
});
</script>

</body>
</html>
